<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <title>Ale Abbey Rezept-Solver</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
  <div class="page">
    <header>
      <h1>üç∫ Ale Abbey ‚Äì Rezept-Solver</h1>
      <p>W√§hle f√ºr jede Eigenschaft die gew√ºnschte Farbzone und lege exakte Wertebereiche fest. Der Solver ber√ºcksichtigt Pflichtzutaten, Mengenlimits und filtert passende Kombinationen f√ºr dich.</p>
    </header>

    <form method="post" action="{{ url_for('index') }}" class="card form-card">
      <section>
        <h3 class="section-title">Grunddaten</h3>
        <div class="grid-two">
          <label>
            <span class="label">Bierstil</span>
            <select name="style">
              {% for s in styles %}
                <option value="{{ s }}" {% if s == style %}selected{% endif %}>{{ s }}</option>
              {% endfor %}
            </select>
          </label>
          <label>
            <span class="label">Gesamtanzahl Zutaten (Cap)</span>
            <input type="number" name="total_cap" min="1" max="30" value="{{ total_cap }}">
          </label>
          <label>
            <span class="label">Max pro Zutat</span>
            <input type="number" name="per_cap" min="1" max="30" value="{{ per_cap }}">
          </label>
        </div>
      </section>

      <section>
        <div class="section-header">
          <h3 class="section-title">Attribute</h3>
          <button type="button" class="btn-secondary" data-set-all-green>Alle Attribute auf Gr√ºn</button>
        </div>
        <div class="attr-grid">
          {% for a in attrs %}
            <div class="attr-card" data-attr-card>
              <h4>{{ attr_labels[a] }}</h4>
              <div class="chips">
                {% for band in ['any', 'green', 'yellow', 'red'] %}
                  {% set label = band_labels.get(band, band) %}
                  <label class="chip" data-color="{{ band }}">
                    <input type="radio" name="band_{{ a }}" value="{{ band }}" {% if constraints[a].band == band %}checked{% endif %}>
                    <span>{{ label }}</span>
                  </label>
                {% endfor %}
              </div>

              <div>
                <label class="label" style="margin-top:12px;">Modus</label>
                <select class="mode-select" name="mode_{{ a }}">
                  <option value="any" {% if constraints[a].mode == 'any' %}selected{% endif %}>Egal</option>
                  <option value="ge" {% if constraints[a].mode == 'ge' %}selected{% endif %}>Mindestens</option>
                  <option value="le" {% if constraints[a].mode == 'le' %}selected{% endif %}>H√∂chstens</option>
                  <option value="between" {% if constraints[a].mode == 'between' %}selected{% endif %}>Zwischen</option>
                </select>
                <div class="range-inputs">
                  <label>Untergrenze
                    <input type="number" class="min-input" name="min_{{ a }}" step="0.1" min="0" max="11" value="{{ constraints[a].min }}">
                  </label>
                  <label>Obergrenze
                    <input type="number" class="max-input" name="max_{{ a }}" step="0.1" min="0" max="11" value="{{ constraints[a].max }}">
                  </label>
                </div>
                <p class="hint">Wertebereich 0.0 ‚Äì 11.0, eine Nachkommastelle.</p>
              </div>
            </div>
          {% endfor %}
        </div>
      </section>

      <section>
        <details class="collapsible" data-collapsible open>
          <summary>
            <h3 class="section-title">Zutaten√ºbersicht</h3>
          </summary>
          <div class="table-wrapper">
            <table class="ingredients-table">
              <thead>
                <tr>
                  <th class="col-checkbox"></th>
                  <th>Name</th>
                  <th>Geschmack</th>
                  <th>Farbe</th>
                  <th>St√§rke</th>
                  <th>Schaum</th>
                </tr>
              </thead>
              <tbody>
                {% for ing in ingredients %}
                  {% set required_count = style_mins.get(ing.name, 0) %}
                  {% set is_required = required_count > 0 %}
                  {% set is_locked = is_required %}
                  {% set is_checked = is_locked or ing.name in selected_optional %}
                  <tr class="{% if is_locked %}ingredient-locked{% endif %}">
                    <td class="checkbox-cell">
                      <label class="ingredient-option" {% if is_locked %}title="Diese Zutat ist vorgegeben."{% endif %}>
                        <input type="checkbox" name="optional_ingredients" value="{{ ing.name }}" {% if is_checked %}checked{% endif %} {% if is_locked %}disabled{% endif %}>
                        <span class="checkbox-visual"></span>
                      </label>
                    </td>
                    <td>
                      <div class="ingredient-name">
                        <span>{{ ing.name }}</span>
                        {% if is_required %}
                          <span class="ingredient-badge badge-required">
                            Pflicht{% if required_count > 1 %} √ó {{ required_count }}{% endif %}
                          </span>
                        {% endif %}
                      </div>
                    </td>
                    <td>{{ '%.1f'|format(ing.vec[0]) }}</td>
                    <td>{{ '%.1f'|format(ing.vec[1]) }}</td>
                    <td>{{ '%.1f'|format(ing.vec[2]) }}</td>
                    <td>{{ '%.1f'|format(ing.vec[3]) }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </details>
      </section>

      <button class="btn-primary" type="submit" data-submit-button {% if not has_active_constraints %}disabled{% endif %}>Rezept berechnen</button>
    </form>

    {% if solutions is not none %}
      <section style="margin-top: 32px;">
        <h2 class="section-title">Ergebnisse ({{ solutions|length }})</h2>
        {% if solutions|length == 0 %}
          <p><strong>Keine L√∂sung</strong> unter den gegebenen Regeln gefunden.</p>
        {% else %}
          <div class="grid-two">
            {% for s in solutions %}
              <div class="card">
                <h3 style="margin-top:0;">Gesamtzutaten: {{ s.sum }}</h3>
                <p style="margin-bottom:8px; font-weight:600;">Zutatenmix</p>
                <div class="chips" style="margin-bottom:12px;">
                  {% for name, cnt in s.counts_by_name.items() %}
                    <span class="chip"><span>{{ name }} √ó {{ cnt }}</span></span>
                  {% endfor %}
                </div>
                <p style="margin:0 0 10px;">Geschmack {{ s.totals[0] }}, Farbe {{ s.totals[1] }}, St√§rke {{ s.totals[2] }}, Schaum {{ s.totals[3] }}</p>
                <div style="display:flex; flex-wrap:wrap; gap:8px; margin-bottom:12px;">
                  {% for a in attrs %}
                    {% set b = s.bands[a] %}
                    {% set pill_class = b.replace('/', '-') %}
                    <span class="pill {{ pill_class }}">{{ attr_labels[a] }}: {{ band_labels.get(b, b) }}</span>
                  {% endfor %}
                </div>
                <details>
                  <summary>Roh-Vektor</summary>
                  <pre class="mono">{{ s.x }}</pre>
                </details>
              </div>
            {% endfor %}
          </div>
        {% endif %}
      </section>
    {% endif %}

    <section style="margin-top: 36px;" class="card">
      <details>
        <summary>JSON ansehen</summary>
        <h3 style="margin-top:16px;">Zutaten</h3>
        <pre class="mono">{{ ingredients_json }}</pre>
        <h3>Bierstile</h3>
        <pre class="mono">{{ styles_json }}</pre>
      </details>
      {% if debug_info %}
        <hr>
        <details open>
          <summary>Debug</summary>
          <pre class="mono">{{ debug_info | join('\n') }}</pre>
        </details>
      {% endif %}
    </section>
  </div>

  <script>
    window.addEventListener('DOMContentLoaded', () => {
      const attrCards = Array.from(document.querySelectorAll('[data-attr-card]'));
      const submitBtn = document.querySelector('[data-submit-button]');
      const setAllGreenBtn = document.querySelector('[data-set-all-green]');

      const updateSubmitState = () => {
        if (!submitBtn) return;
        const hasConstraint = attrCards.some(card => {
          const selectedBand = card.querySelector('input[type="radio"]:checked');
          const modeSelect = card.querySelector('.mode-select');
          const bandActive = selectedBand && selectedBand.value !== 'any';
          const modeActive = modeSelect && modeSelect.value !== 'any';
          return bandActive || modeActive;
        });
        submitBtn.disabled = !hasConstraint;
      };

      attrCards.forEach(card => {
        const modeSelect = card.querySelector('.mode-select');
        const minInput = card.querySelector('.min-input');
        const maxInput = card.querySelector('.max-input');

        const toggle = () => {
          const mode = modeSelect.value;
          if (mode === 'any') {
            minInput.disabled = true;
            maxInput.disabled = true;
          } else if (mode === 'ge') {
            minInput.disabled = false;
            maxInput.disabled = true;
          } else if (mode === 'le') {
            minInput.disabled = true;
            maxInput.disabled = false;
          } else {
            minInput.disabled = false;
            maxInput.disabled = false;
          }
          updateSubmitState();
        };

        toggle();
        modeSelect.addEventListener('change', toggle);
        card.querySelectorAll('input[type="radio"]').forEach(radio => {
          radio.addEventListener('change', updateSubmitState);
        });
      });

      if (setAllGreenBtn) {
        setAllGreenBtn.addEventListener('click', () => {
          attrCards.forEach(card => {
            const greenRadio = card.querySelector('input[type="radio"][value="green"]');
            if (greenRadio) {
              greenRadio.checked = true;
            }
          });
          updateSubmitState();
        });
      }

      updateSubmitState();
    });
  </script>
</body>
</html>
