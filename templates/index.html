<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <title>Ale Abbey Rezept-Solver</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
  <div class="page">
    <header>
      <h1>üç∫ Ale Abbey ‚Äì Rezept-Solver</h1>
      <p>W√§hle f√ºr jede Eigenschaft die gew√ºnschte Farbzone und lege exakte Wertebereiche fest. Die Berechnung l√§uft vollst√§ndig im Browser und ber√ºcksichtigt Pflichtzutaten, Mengenlimits und optionale W√ºnsche.</p>
    </header>

    <form class="card form-card" data-solver-form>
      <section>
        <h3 class="section-title">Grunddaten</h3>
        <div class="grid-two">
          <label>
            <span class="label">Bierstil</span>
            <select name="style">
              {% for s in styles %}
                <option value="{{ s }}" {% if s == style %}selected{% endif %}>{{ s }}</option>
              {% endfor %}
            </select>
          </label>
          <label>
            <span class="label">Gesamtanzahl Zutaten (Cap)</span>
            <input type="number" name="total_cap" min="1" max="30" value="{{ total_cap }}">
          </label>
          <label>
            <span class="label">Max pro Zutat</span>
            <input type="number" name="per_cap" min="1" max="30" value="{{ per_cap }}">
          </label>
        </div>
      </section>

      <section>
        <div class="section-header">
          <h3 class="section-title">Attribute</h3>
          <button type="button" class="btn-secondary" data-set-all-green>Alle Attribute auf Gr√ºn</button>
        </div>
        <div class="attr-grid">
          {% for a in attrs %}
            <div class="attr-card" data-attr-card>
              <h4>{{ attr_labels[a] }}</h4>
              <div class="chips">
                {% for band in ['any', 'green', 'yellow', 'red'] %}
                  {% set label = band_labels.get(band, band) %}
                  <label class="chip" data-color="{{ band }}">
                    <input type="radio" name="band_{{ a }}" value="{{ band }}" {% if constraints[a].band == band %}checked{% endif %}>
                    <span>{{ label }}</span>
                  </label>
                {% endfor %}
              </div>

              <div>
                <label class="label" style="margin-top:12px;">Modus</label>
                <select class="mode-select" name="mode_{{ a }}">
                  <option value="any" {% if constraints[a].mode == 'any' %}selected{% endif %}>Egal</option>
                  <option value="ge" {% if constraints[a].mode == 'ge' %}selected{% endif %}>Mindestens</option>
                  <option value="le" {% if constraints[a].mode == 'le' %}selected{% endif %}>H√∂chstens</option>
                  <option value="between" {% if constraints[a].mode == 'between' %}selected{% endif %}>Zwischen</option>
                </select>
                <div class="range-inputs">
                  <label>Untergrenze
                    <input type="number" class="min-input" name="min_{{ a }}" step="0.1" min="0" max="11" value="{{ constraints[a].min }}">
                  </label>
                  <label>Obergrenze
                    <input type="number" class="max-input" name="max_{{ a }}" step="0.1" min="0" max="11" value="{{ constraints[a].max }}">
                  </label>
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      </section>

      <section>
        <details class="collapsible" data-collapsible open>
          <summary>
            <h3 class="section-title">Zutaten√ºbersicht</h3>
          </summary>
          <div class="table-wrapper">
            <table class="ingredients-table">
              <thead>
                <tr>
                  <th class="col-checkbox"></th>
                  <th>Name</th>
                  <th>Geschmack</th>
                  <th>Farbe</th>
                  <th>St√§rke</th>
                  <th>Schaum</th>
                </tr>
              </thead>
              <tbody>
                {% for ing in ingredients %}
                  {% set required_count = style_mins.get(ing.name, 0) %}
                  {% set is_required = required_count > 0 %}
                  {% set is_locked = is_required %}
                  {% set is_checked = is_locked or ing.name in selected_optional %}
                  <tr class="{% if is_locked %}ingredient-locked{% endif %}" data-ingredient-row data-ingredient-name="{{ ing.name }}">
                    <td class="checkbox-cell">
                      <label class="ingredient-option" {% if is_locked %}title="Diese Zutat ist vorgegeben."{% endif %}>
                        <input type="checkbox" name="optional_ingredients" value="{{ ing.name }}" {% if is_checked %}checked{% endif %} {% if is_locked %}disabled{% endif %} data-user-selected="{{ 'true' if ing.name in selected_optional else 'false' }}">
                        <span class="checkbox-visual"></span>
                      </label>
                    </td>
                    <td>
                      <div class="ingredient-name">
                        <span>{{ ing.name }}</span>
                        <span class="ingredient-badge badge-required" data-required-badge {% if not is_required %}hidden{% endif %}>
                          {% if is_required %}
                            Pflicht{% if required_count > 1 %} √ó {{ required_count }}{% endif %}
                          {% else %}
                            Pflicht
                          {% endif %}
                        </span>
                      </div>
                    </td>
                    <td>{{ '%.1f'|format(ing.vec[0]) }}</td>
                    <td>{{ '%.1f'|format(ing.vec[1]) }}</td>
                    <td>{{ '%.1f'|format(ing.vec[2]) }}</td>
                    <td>{{ '%.1f'|format(ing.vec[3]) }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </details>
      </section>

      <button class="btn-primary" type="submit" data-submit-button {% if not has_active_constraints %}disabled{% endif %}>Rezept berechnen</button>
    </form>

    <section class="results-section" data-results hidden style="margin-top: 32px;">
      <h2 class="section-title" data-results-title>Ergebnisse</h2>
      <p class="hint" data-results-summary></p>
      <p class="hint" data-status-message hidden></p>
      <p data-results-empty hidden><strong>Keine L√∂sung</strong> unter den gegebenen Regeln gefunden.</p>
      <div class="grid-two" data-results-list></div>
    </section>

    <section style="margin-top: 36px;" class="card" data-debug-container>
      <label class="checkbox-inline">
        <input type="checkbox" id="debug-toggle">
        <span>Debug anzeigen</span>
      </label>
      <div class="debug-content" data-debug-content hidden>
        <details>
          <summary>JSON ansehen</summary>
          <h3 style="margin-top:16px;">Zutaten</h3>
          <pre class="mono">{{ ingredients_json }}</pre>
          <h3>Bierstile</h3>
          <pre class="mono">{{ styles_json }}</pre>
        </details>
        <hr>
        <div class="debug-panel" data-debug-panel hidden>
          <h3>Debug</h3>
          <pre class="mono" data-debug-output></pre>
        </div>
      </div>
    </section>
  </div>

  <script id="ingredients-data" type="application/json">{{ ingredients_data | tojson }}</script>
  <script id="styles-data" type="application/json">{{ styles_data | tojson }}</script>
  <script id="meta-data" type="application/json">{{ {'attrs': attrs, 'attr_labels': attr_labels, 'band_labels': band_labels} | tojson }}</script>
  <script id="style-min-data" type="application/json">{{ style_min_map | tojson }}</script>
  <script type="module" src="{{ url_for('static', filename='solver.js') }}"></script>
</body>
</html>
